{% extends "two_factor/base_auth.html" %}
{% load i18n %}

{% block page_title %}{% trans "Enable Two-Factor Authentication" %}{% endblock %}

{% block extra_media %}
  {{ wizard.form.media }}
{% endblock %}

{% block content %}
  <h1>{% trans "Enable Two-Factor Authentication" %}</h1>

  {# Step-specific description #}
  {% if wizard.steps.current == 'welcome' %}
    <p>{% trans "You're about to improve your account security. Follow the steps to enable two-factor authentication." %}</p>
  {% elif wizard.steps.current == 'method' %}
    <p>{% trans "Choose your preferred authentication method." %}</p>
  {% elif wizard.steps.current == 'generator' %}
    <p>{% trans "Scan the QR code below using your authenticator app (e.g., Google Authenticator)." %}</p>
    <img src="{{ QR_URL }}" alt="QR Code" />
    <p>{% trans "Alternatively, use this secret key manually:" %}</p>
    <p><strong>{% trans "TOTP Secret:" %}</strong> <a href="{{ otpauth_url }}">{{ secret_key }}</a></p>
    <p>{% trans "Then enter the token generated by your app." %}</p>
  {% elif wizard.steps.current == 'sms' %}
    <p>{% trans "Enter the phone number to receive SMS tokens." %}</p>
  {% elif wizard.steps.current == 'call' %}
    <p>{% trans "Enter the phone number to receive voice calls." %}</p>
  {% elif wizard.steps.current == 'validation' %}
    {% if challenge_succeeded %}
      {% if device.method == 'call' %}
        <p>{% trans "We are calling your phone now. Enter the digits you hear." %}</p>
      {% elif device.method == 'sms' %}
        <p>{% trans "We sent you an SMS. Enter the token we sent." %}</p>
      {% endif %}
    {% else %}
    <div class="alert alert-warning" role="alert">
      {% trans "There was a problem with the selected method. Please check the number or try a different method." %}
      </div>
    {% endif %}
  {% elif wizard.steps.current == 'yubikey' %}
    <p>{% trans "Insert your YubiKey and touch it to generate a token." %}</p>
  {% endif %}

  {# Multi-step form starts here #}
  <form method="post" autocomplete="off" novalidate>
    {% csrf_token %}
    {{ wizard.management_form }}

    {% if wizard.form.non_field_errors %}
      <div class="error">
        {{ wizard.form.non_field_errors }}
      </div>
    {% endif %}

    {# Render form fields dynamically #}
    <div class="form-fields">
      {% for field in wizard.form.visible_fields %}
      <div>
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% if field.help_text %}
          <small>{{ field.help_text }}</small>
        {% endif %}
        {% if field.errors %}
          <div>{{ field.errors }}</div>
        {% endif %}
      </div>
    {% endfor %}    
    </div>

    <input type="submit" hidden />
    
    {# Navigation buttons: Back then Next #}
    <div>
      {% if wizard.steps.prev %}
        <button type="submit" name="wizard_goto_step" value="{{ wizard.steps.prev }}">
          {% trans "Back" %}
        </button>
      {% endif %}
      <button type="submit">
        {% trans "Next" %}
      </button>
    </div>    
  </form>
{% endblock %}
